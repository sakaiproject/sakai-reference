-- clear unchanged bundle properties
DELETE SAKAI_MESSAGE_BUNDLE from SAKAI_MESSAGE_BUNDLE where PROP_VALUE is NULL;

-- SAK-40427
UPDATE SAKAI_SITE_TOOL SET TITLE = 'Discussions' WHERE REGISTRATION = 'sakai.forums' AND TITLE = 'Forums';
UPDATE SAKAI_SITE_PAGE SET TITLE = 'Discussions' WHERE TITLE = 'Forums';
-- End SAK-40427

-- SAK-45565
ALTER TABLE lesson_builder_groups CHANGE COLUMN `groups` item_groups LONGTEXT NULL DEFAULT NULL;
ALTER TABLE lesson_builder_items CHANGE COLUMN `groups` item_groups LONGTEXT NULL DEFAULT NULL;
ALTER TABLE tasks CHANGE COLUMN `SYSTEM` SYSTEM_TASK BIT(1) NOT NULL;
-- SAK-45565

-- SAK-44967
ALTER TABLE GB_GRADEBOOK_T ADD COLUMN ALLOW_COMPARE_GRADES BIT(1) DEFAULT FALSE NOT NULL;
ALTER TABLE GB_GRADEBOOK_T ADD COLUMN COMPARING_DISPLAY_FIRSTNAMES BIT(1) DEFAULT FALSE NOT NULL;
ALTER TABLE GB_GRADEBOOK_T ADD COLUMN COMPARING_DISPLAY_SURNAMES BIT(1) DEFAULT FALSE NOT NULL;
ALTER TABLE GB_GRADEBOOK_T ADD COLUMN COMPARING_DISPLAY_COMMENTS BIT(1) DEFAULT FALSE NOT NULL;
ALTER TABLE GB_GRADEBOOK_T ADD COLUMN COMPARING_DISPLAY_ALLITEMS BIT(1) DEFAULT FALSE NOT NULL;
ALTER TABLE GB_GRADEBOOK_T ADD COLUMN COMPARING_RANDOMIZEDATA BIT(1) DEFAULT FALSE NOT NULL;
-- End SAK-44967

-- SAK-46030

-- Create functions
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('dropbox.write.own');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('dropbox.write.any');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('dropbox.delete.own');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('dropbox.delete.any');

-- Conversations
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.anonymous.view');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.comment.create');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.comment.delete.any');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.comment.delete.own');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.comment.update.any');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.comment.update.own');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.moderate');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.post.create');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.post.delete.any');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.post.delete.own');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.post.react');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.post.update.any');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.post.update.own');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.post.upvote');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.roletype.instructor');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.statistics.view');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.tag.create');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.topic.create');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.topic.delete.any');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.topic.delete.own');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.topic.pin');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.topic.tag');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.topic.update.any');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.topic.update.own');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('conversations.topic.view.groups');

-- Project sites - maintainers get .any permissions, accessors get .own permissions
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY) VALUES (
    (SELECT REALM_KEY FROM SAKAI_REALM WHERE REALM_ID = '!site.template'),
    (SELECT ROLE_KEY FROM SAKAI_REALM_ROLE WHERE ROLE_NAME = 'maintain'),
    (SELECT FUNCTION_KEY FROM SAKAI_REALM_FUNCTION WHERE FUNCTION_NAME = 'dropbox.write.any')
);
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY) VALUES (
    (SELECT REALM_KEY FROM SAKAI_REALM WHERE REALM_ID = '!site.template'),
    (SELECT ROLE_KEY FROM SAKAI_REALM_ROLE WHERE ROLE_NAME = 'maintain'),
    (SELECT FUNCTION_KEY FROM SAKAI_REALM_FUNCTION WHERE FUNCTION_NAME = 'dropbox.delete.any')
);
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY) VALUES (
    (SELECT REALM_KEY FROM SAKAI_REALM WHERE REALM_ID = '!site.template'),
    (SELECT ROLE_KEY FROM SAKAI_REALM_ROLE WHERE ROLE_NAME = 'access'),
    (SELECT FUNCTION_KEY FROM SAKAI_REALM_FUNCTION WHERE FUNCTION_NAME = 'dropbox.write.own')
);
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY) VALUES (
    (SELECT REALM_KEY FROM SAKAI_REALM WHERE REALM_ID = '!site.template'),
    (SELECT ROLE_KEY FROM SAKAI_REALM_ROLE WHERE ROLE_NAME = 'access'),
    (SELECT FUNCTION_KEY FROM SAKAI_REALM_FUNCTION WHERE FUNCTION_NAME = 'dropbox.delete.own')
);
-- Give instructor the '.any' permissions in !site.template.course
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY) VALUES (
    (SELECT REALM_KEY FROM SAKAI_REALM WHERE REALM_ID = '!site.template.course'),
    (SELECT ROLE_KEY FROM SAKAI_REALM_ROLE WHERE ROLE_NAME = 'Instructor'),
    (SELECT FUNCTION_KEY FROM SAKAI_REALM_FUNCTION WHERE FUNCTION_NAME = 'dropbox.write.any')
);
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY) VALUES (
    (SELECT REALM_KEY FROM SAKAI_REALM WHERE REALM_ID = '!site.template.course'),
    (SELECT ROLE_KEY FROM SAKAI_REALM_ROLE WHERE ROLE_NAME = 'Instructor'),
    (SELECT FUNCTION_KEY FROM SAKAI_REALM_FUNCTION WHERE FUNCTION_NAME = 'dropbox.delete.any')
);
-- Give student and TA the '.own' permissions in !site.template.course
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY) VALUES (
    (SELECT REALM_KEY FROM SAKAI_REALM WHERE REALM_ID = '!site.template.course'),
    (SELECT ROLE_KEY FROM SAKAI_REALM_ROLE WHERE ROLE_NAME = 'Student'),
    (SELECT FUNCTION_KEY FROM SAKAI_REALM_FUNCTION WHERE FUNCTION_NAME = 'dropbox.write.own')
);
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY) VALUES (
    (SELECT REALM_KEY FROM SAKAI_REALM WHERE REALM_ID = '!site.template.course'),
    (SELECT ROLE_KEY FROM SAKAI_REALM_ROLE WHERE ROLE_NAME = 'Student'),
    (SELECT FUNCTION_KEY FROM SAKAI_REALM_FUNCTION WHERE FUNCTION_NAME = 'dropbox.delete.own')
);
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY) VALUES (
    (SELECT REALM_KEY FROM SAKAI_REALM WHERE REALM_ID = '!site.template.course'),
    (SELECT ROLE_KEY FROM SAKAI_REALM_ROLE WHERE ROLE_NAME = 'Teaching Assistant'),
    (SELECT FUNCTION_KEY FROM SAKAI_REALM_FUNCTION WHERE FUNCTION_NAME = 'dropbox.write.own')
);
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY) VALUES (
    (SELECT REALM_KEY FROM SAKAI_REALM WHERE REALM_ID = '!site.template.course'),
    (SELECT ROLE_KEY FROM SAKAI_REALM_ROLE WHERE ROLE_NAME = 'Teaching Assistant'),
    (SELECT FUNCTION_KEY FROM SAKAI_REALM_FUNCTION WHERE FUNCTION_NAME = 'dropbox.delete.own')
);

-- --------------------------------------------------------------------------------------------------------------------------------------
-- backfill new permission into existing realms
-- --------------------------------------------------------------------------------------------------------------------------------------
CREATE TABLE PERMISSIONS_SRC_TEMP (ROLE_NAME VARCHAR(99), FUNCTION_NAME VARCHAR(99));

INSERT INTO PERMISSIONS_SRC_TEMP VALUES('maintain','dropbox.write.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES('maintain','dropbox.delete.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES('access','dropbox.write.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES('access','dropbox.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES('Instructor','dropbox.write.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES('Instructor','dropbox.delete.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES('Student','dropbox.write.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES('Student','dropbox.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES('Teaching Assistant','dropbox.write.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES('Teaching Assistant','dropbox.delete.own');

-- Conversations
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.roletype.instructor');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.moderate');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.topic.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.topic.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.topic.update.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.topic.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.topic.delete.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.topic.tag');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.topic.pin');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.tag.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.topic.view.groups');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.post.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.post.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.post.update.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.post.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.post.delete.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.post.verify');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.post.react');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.post.comment');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.comment.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.comment.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.comment.update.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.comment.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.comment.delete.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.statistics.view');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Instructor','conversations.anonymous.view');

INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.roletype.instructor');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.moderate');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.topic.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.topic.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.topic.update.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.topic.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.topic.delete.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.topic.tag');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.topic.pin');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.tag.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.topic.view.groups');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.post.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.post.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.post.update.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.post.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.post.delete.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.post.verify');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.post.react');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.post.comment');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.comment.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.comment.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.comment.update.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.comment.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.comment.delete.any');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.statistics.view');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('maintain','conversations.anonymous.view');

INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.topic.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.topic.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.topic.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.topic.tag');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.post.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.post.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.post.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.post.react');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.post.comment');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.comment.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.comment.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('Student','conversations.comment.delete.own');

INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.topic.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.topic.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.topic.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.topic.tag');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.post.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.post.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.post.delete.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.post.react');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.post.comment');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.comment.create');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.comment.update.own');
INSERT INTO PERMISSIONS_SRC_TEMP VALUES ('access','conversations.comment.delete.own');

-- lookup the role and function number
CREATE TABLE PERMISSIONS_TEMP (ROLE_KEY INTEGER, FUNCTION_KEY INTEGER);
INSERT INTO PERMISSIONS_TEMP (ROLE_KEY, FUNCTION_KEY)
SELECT SRR.ROLE_KEY, SRF.FUNCTION_KEY
FROM PERMISSIONS_SRC_TEMP TMPSRC
JOIN SAKAI_REALM_ROLE SRR ON (TMPSRC.ROLE_NAME = SRR.ROLE_NAME)
JOIN SAKAI_REALM_FUNCTION SRF ON (TMPSRC.FUNCTION_NAME = SRF.FUNCTION_NAME);

-- insert the new function into the roles of any existing realm that has the role (don't convert the "!site.helper")
INSERT INTO SAKAI_REALM_RL_FN (REALM_KEY, ROLE_KEY, FUNCTION_KEY)
SELECT
    SRRFD.REALM_KEY, SRRFD.ROLE_KEY, TMP.FUNCTION_KEY
FROM
    (SELECT DISTINCT SRRF.REALM_KEY, SRRF.ROLE_KEY FROM SAKAI_REALM_RL_FN SRRF) SRRFD
    JOIN PERMISSIONS_TEMP TMP ON (SRRFD.ROLE_KEY = TMP.ROLE_KEY)
    JOIN SAKAI_REALM SR ON (SRRFD.REALM_KEY = SR.REALM_KEY)
    WHERE SR.REALM_ID != '!site.helper'
    AND NOT EXISTS (
        SELECT 1
            FROM SAKAI_REALM_RL_FN SRRFI
            WHERE SRRFI.REALM_KEY=SRRFD.REALM_KEY AND SRRFI.ROLE_KEY=SRRFD.ROLE_KEY AND SRRFI.FUNCTION_KEY=TMP.FUNCTION_KEY
    );

-- clean up the temp tables
DROP TABLE PERMISSIONS_TEMP;
DROP TABLE PERMISSIONS_SRC_TEMP;

-- END SAK-46030

-- SAK-46022
ALTER TABLE COMMONS_POST ADD COLUMN PRIORITY BIT(1) DEFAULT 0 NOT NULL;
-- End SAK-46022

-- SAK-43155
ALTER TABLE ASN_ASSIGNMENT ADD ESTIMATE_REQUIRED BIT(1) DEFAULT 0 NOT NULL;
ALTER TABLE ASN_ASSIGNMENT ADD ESTIMATE VARCHAR(255) NULL;
-- End SAK-43155

-- SAK-46021
CREATE TABLE COMMONS_LIKE (
USER_ID VARCHAR(99) NOT NULL,
POST_ID CHAR(36) NOT NULL,
VOTE bit(1) DEFAULT 0 NOT NULL,
MODIFIED_DATE datetime,
PRIMARY KEY (USER_ID, POST_ID)
);
-- End SAK-46021

-- SAK-46137
ALTER TABLE SAKAI_PERSON_T ADD PRINCIPAL_NAME_PRIOR varchar(255) DEFAULT NULL;
ALTER TABLE SAKAI_PERSON_T ADD SCOPED_AFFILIATION varchar(255) DEFAULT NULL;
ALTER TABLE SAKAI_PERSON_T ADD TARGETED_ID varchar(255) DEFAULT NULL;
ALTER TABLE SAKAI_PERSON_T ADD ASSURANCE varchar(255) DEFAULT NULL;
ALTER TABLE SAKAI_PERSON_T ADD UNIQUE_ID varchar(255) DEFAULT NULL;
ALTER TABLE SAKAI_PERSON_T ADD ORCID varchar(255) DEFAULT NULL;
-- End SAK-46137 

-- SAK-46085
ALTER TABLE PROFILE_SOCIAL_INFO_T ADD COLUMN INSTAGRAM_URL VARCHAR(255) NULL;
-- End SAK-46085

-- Start /SAK-46977
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('sitestats.all');
INSERT INTO SAKAI_REALM_FUNCTION (FUNCTION_NAME) VALUES('sitestats.own');
INSERT INTO SAKAI_REALM_RL_FN VALUES (
    (SELECT REALM_KEY from SAKAI_REALM where REALM_ID = '!site.template'),
    (SELECT ROLE_KEY from SAKAI_REALM_ROLE where ROLE_NAME = 'access'),
    (SELECT FUNCTION_KEY  from SAKAI_REALM_FUNCTION where FUNCTION_NAME = 'sitestats.own')
);
INSERT INTO SAKAI_REALM_RL_FN VALUES (
    (SELECT REALM_KEY from SAKAI_REALM where REALM_ID = '!site.template.course'),
    (SELECT ROLE_KEY from SAKAI_REALM_ROLE where ROLE_NAME = 'Student'),
    (SELECT FUNCTION_KEY  from SAKAI_REALM_FUNCTION where FUNCTION_NAME = 'sitestats.own')
);
INSERT INTO SAKAI_REALM_RL_FN VALUES (
    (SELECT REALM_KEY from SAKAI_REALM where REALM_ID = '!site.template'),
    (SELECT ROLE_KEY from SAKAI_REALM_ROLE where ROLE_NAME = 'maintain'),
    (SELECT FUNCTION_KEY  from SAKAI_REALM_FUNCTION where FUNCTION_NAME = 'sitestats.all')
);
INSERT INTO SAKAI_REALM_RL_FN VALUES (
    (SELECT REALM_KEY from SAKAI_REALM where REALM_ID = '!site.template.course'),
    (SELECT ROLE_KEY from SAKAI_REALM_ROLE where ROLE_NAME = 'Instructor'),
    (SELECT FUNCTION_KEY  from SAKAI_REALM_FUNCTION where FUNCTION_NAME = 'sitestats.all')
);
-- End /SAK-46977

-- SAK-45092
CREATE TABLE CONV_COMMENTS (
  COMMENT_ID VARCHAR(36) NOT NULL,
  `LOCKED` BIT DEFAULT 0 NULL,
  MESSAGE VARCHAR(255) NOT NULL,
  CREATED datetime NOT NULL,
  CREATOR VARCHAR(99) NULL,
  MODIFIED datetime DEFAULT NULL NULL,
  MODIFIER VARCHAR(99) NULL,
  SITE_ID VARCHAR(99) NOT NULL,
  POST_ID VARCHAR(36) NOT NULL,
  CONSTRAINT PK_CONV_COMMENTS PRIMARY KEY (COMMENT_ID)
);

CREATE TABLE CONV_POSTS (
  POST_ID VARCHAR(36) NOT NULL,
  ANONYMOUS BIT DEFAULT 0 NULL,
  DRAFT BIT DEFAULT 0 NULL,
  HIDDEN BIT DEFAULT 0 NULL,
  `LOCKED` BIT DEFAULT 0 NULL,
  MESSAGE LONGTEXT NOT NULL,
  CREATED datetime NOT NULL,
  CREATOR VARCHAR(99) NULL,
  MODIFIED datetime DEFAULT NULL NULL,
  MODIFIER VARCHAR(99) NULL,
  NUMBER_OF_COMMENTS INT DEFAULT NULL NULL,
  PRIVATE_POST BIT DEFAULT 0 NULL,
  SITE_ID VARCHAR(99) NOT NULL,
  UPVOTES INT DEFAULT NULL NULL,
  PARENT_POST_ID VARCHAR(36) NULL,
  TOPIC_ID VARCHAR(36) NOT NULL,
  CONSTRAINT PK_CONV_POSTS PRIMARY KEY (POST_ID)
);

CREATE TABLE CONV_POST_REACTIONS (
  ID BIGINT AUTO_INCREMENT NOT NULL,
  REACTION INT NOT NULL,
  REACTION_STATE BIT DEFAULT 0 NULL,
  USER_ID VARCHAR(99) NOT NULL,
  POST_ID VARCHAR(36) NOT NULL,
  CONSTRAINT PK_CONV_POST_REACTIONS PRIMARY KEY (ID)
);

CREATE TABLE CONV_POST_REACTION_TOTALS (
  ID BIGINT AUTO_INCREMENT NOT NULL,
  REACTION INT NOT NULL,
  TOTAL INT NOT NULL,
  POST_ID VARCHAR(36) NOT NULL,
  CONSTRAINT PK_CONV_POST_REACTION_TOTALS PRIMARY KEY (ID)
);

CREATE TABLE CONV_POST_STATUS (
  ID BIGINT AUTO_INCREMENT NOT NULL,
  POST_ID VARCHAR(255) NOT NULL,
  TOPIC_ID VARCHAR(255) NOT NULL,
  UPVOTED BIT DEFAULT 0 NULL,
  USER_ID VARCHAR(99) NOT NULL,
  VIEWED BIT DEFAULT 0 NULL,
  VIEWED_DATE datetime DEFAULT NULL NULL,
  CONSTRAINT PK_CONV_POST_STATUS PRIMARY KEY (ID)
);

CREATE TABLE CONV_SETTINGS (
  ID BIGINT AUTO_INCREMENT NOT NULL,
  ALLOW_ANON_POSTING BIT DEFAULT 0 NULL,
  ALLOW_BOOKMARKING BIT DEFAULT 0 NULL,
  ALLOW_PINNING BIT DEFAULT 0 NULL,
  ALLOW_REACTIONS BIT DEFAULT 0 NULL,
  ALLOW_UPVOTING BIT DEFAULT 0 NULL,
  DEFAULT_TOPIC_TYPE VARCHAR(32) NULL,
  GUIDELINES LONGTEXT NULL,
  REQUIRE_GUIDELINES_AGREEMENT BIT DEFAULT 0 NULL,
  SITE_ID VARCHAR(99) NOT NULL,
  SITE_LOCKED BIT DEFAULT 0 NULL,
  CONSTRAINT PK_CONV_SETTINGS PRIMARY KEY (ID),
  UNIQUE (SITE_ID)
);

CREATE TABLE CONV_STATUS (
  ID BIGINT AUTO_INCREMENT NOT NULL,
  GUIDELINES_AGREED BIT DEFAULT 0 NULL,
  SITE_ID VARCHAR(99) NOT NULL,
  USER_ID VARCHAR(99) NOT NULL,
  CONSTRAINT PK_CONV_STATUS PRIMARY KEY (ID)
);

CREATE TABLE CONV_TAGS (
  TAG_ID BIGINT AUTO_INCREMENT NOT NULL,
  `DESCRIPTION` VARCHAR(255) NULL,
  LABEL VARCHAR(255) NOT NULL,
  SITE_ID VARCHAR(99) NOT NULL,
  CONSTRAINT PK_CONV_TAGS PRIMARY KEY (TAG_ID)
);

CREATE TABLE CONV_TOPICS (
  TOPIC_ID VARCHAR(36) NOT NULL,
  ABOUT_REFERENCE VARCHAR(255) NULL,
  ALLOW_ANONYMOUS_POSTS BIT DEFAULT 0 NULL,
  ANONYMOUS BIT DEFAULT 0 NULL,
  DRAFT BIT DEFAULT 0 NULL,
  HIDDEN BIT DEFAULT 0 NULL,
  HOW_ACTIVE INT DEFAULT NULL NULL,
  LAST_ACTIVITY datetime DEFAULT NULL NULL,
  `LOCKED` BIT DEFAULT 0 NULL,
  MESSAGE LONGTEXT NULL,
  CREATED datetime NOT NULL,
  CREATOR VARCHAR(99) NULL,
  MODIFIED datetime DEFAULT NULL NULL,
  MODIFIER VARCHAR(99) NULL,
  PINNED BIT DEFAULT 0 NULL,
  RESOLVED BIT DEFAULT 0 NULL,
  SITE_ID VARCHAR(99) NOT NULL,
  TITLE VARCHAR(255) NOT NULL,
  TOPIC_TYPE VARCHAR(32) NULL,
  VISIBILITY VARCHAR(32) NULL,
  CONSTRAINT PK_CONV_TOPICS PRIMARY KEY (TOPIC_ID)
);

CREATE TABLE CONV_TOPIC_GROUPS (
  TOPIC_ID VARCHAR(36) NOT NULL,
  GROUP_ID VARCHAR(255) NULL
);

CREATE TABLE CONV_TOPIC_REACTIONS (
  ID BIGINT AUTO_INCREMENT NOT NULL,
  REACTION INT NOT NULL,
  REACTION_STATE BIT DEFAULT 0 NULL,
  USER_ID VARCHAR(99) NOT NULL,
  TOPIC_ID VARCHAR(36) NOT NULL,
  CONSTRAINT PK_CONV_TOPIC_REACTIONS PRIMARY KEY (ID)
);

CREATE TABLE CONV_TOPIC_REACTION_TOTALS (
  ID BIGINT AUTO_INCREMENT NOT NULL,
  REACTION INT NOT NULL,
  TOTAL INT NOT NULL,
  TOPIC_ID VARCHAR(36) NOT NULL,
  CONSTRAINT PK_CONV_TOPIC_REACTION_TOTALS PRIMARY KEY (ID)
);

CREATE TABLE CONV_TOPIC_STATUS (
  ID BIGINT AUTO_INCREMENT NOT NULL,
  BOOKMARKED BIT DEFAULT 0 NULL,
  SITE_ID VARCHAR(255) NOT NULL,
  TOPIC_ID VARCHAR(255) NOT NULL,
  UNREAD INT DEFAULT NULL NULL,
  USER_ID VARCHAR(99) NOT NULL,
  VIEWED BIT DEFAULT 0 NULL,
  CONSTRAINT PK_CONV_TOPIC_STATUS PRIMARY KEY (ID)
);

CREATE TABLE CONV_TOPIC_TAGS (
  TOPIC_ID VARCHAR(36) NOT NULL,
  TAG BIGINT DEFAULT NULL NULL
);

CREATE TABLE CONV_USER_STATISTICS (
  ID BIGINT NOT NULL,
  LAST_POST_DATE datetime DEFAULT NULL NULL,
  NUMBER_OF_POSTS INT DEFAULT NULL NULL,
  NUMBER_OF_REACTIONS INT DEFAULT NULL NULL,
  NUMBER_OF_REPLIES INT DEFAULT NULL NULL,
  NUMBER_OF_UPVOTES INT DEFAULT NULL NULL,
  NUMBER_READ INT DEFAULT NULL NULL,
  USER_ID VARCHAR(99) NOT NULL,
  TOPIC_ID VARCHAR(36) NULL,
  CONSTRAINT PK_CONV_USER_STATISTICS PRIMARY KEY (ID)
);

ALTER TABLE CONV_STATUS ADD CONSTRAINT UniqueConvStatus UNIQUE (SITE_ID, USER_ID);
ALTER TABLE CONV_POST_REACTION_TOTALS ADD CONSTRAINT UniquePostReactionTotals UNIQUE (POST_ID, REACTION);
ALTER TABLE CONV_POST_REACTIONS ADD CONSTRAINT UniquePostReactions UNIQUE (POST_ID, USER_ID, REACTION);
ALTER TABLE CONV_POST_STATUS ADD CONSTRAINT UniquePostStatus UNIQUE (POST_ID, USER_ID);
ALTER TABLE CONV_TOPIC_REACTION_TOTALS ADD CONSTRAINT UniqueTopicReactionTotals UNIQUE (TOPIC_ID, REACTION);
ALTER TABLE CONV_TOPIC_REACTIONS ADD CONSTRAINT UniqueTopicReactions UNIQUE (TOPIC_ID, USER_ID, REACTION);
ALTER TABLE CONV_TOPIC_STATUS ADD CONSTRAINT UniqueTopicStatus UNIQUE (TOPIC_ID, USER_ID);

CREATE INDEX FKc21ukywsqsqilxlsdrg4x6qka ON CONV_POSTS(PARENT_POST_ID);
CREATE INDEX FKi9pfkqq0396p0kl718e9mrakk ON CONV_USER_STATISTICS(TOPIC_ID);
CREATE INDEX FKj8o3cwa4flprmopiaa1xxi91s ON CONV_TOPIC_GROUPS(TOPIC_ID);
CREATE INDEX FKrmek6b1bqs2jghppp27ph2dn9 ON CONV_TOPIC_TAGS(TOPIC_ID);
CREATE INDEX IDX3nridt976wgqrd0vxge273ctk ON CONV_POST_REACTIONS(POST_ID);
CREATE INDEX IDX4vl5kx35nbj7mm5tjc789pkrs ON CONV_POST_STATUS(POST_ID);
CREATE INDEX IDX59e65g24yqkm9d4omljmdk2i9 ON CONV_POSTS(SITE_ID);
CREATE INDEX IDX9tgexj1wml170sorc2agiac1i ON CONV_TAGS(SITE_ID);
CREATE INDEX IDXbb22xsa2tdsm7jv8v0w1rwxvh ON CONV_POST_REACTION_TOTALS(POST_ID);
CREATE INDEX IDXdsq2b214fvqnhxevs6ogx37po ON CONV_POST_REACTIONS(POST_ID, USER_ID);
CREATE INDEX IDXeisyrk9cbbkdmqo5on3e7pysg ON CONV_COMMENTS(SITE_ID);
CREATE INDEX IDXhw1kgsuv0qp47fvc8meopwaea ON CONV_POST_STATUS(TOPIC_ID, USER_ID);
CREATE INDEX IDXih3xad6e7nljy7cw8dsinq5j4 ON CONV_POSTS(TOPIC_ID);
CREATE INDEX IDXjuusvvw52sys4e6fa9bn5rs6t ON CONV_USER_STATISTICS(USER_ID);
CREATE INDEX IDXl2syeorinknc7t5e8jrctam81 ON CONV_POST_STATUS(USER_ID);
CREATE INDEX IDXo21yr7ncf5o3qrtwv36pc083k ON CONV_TOPICS(SITE_ID);
CREATE INDEX IDXp4bavayq4l7jiplafk6swbst ON CONV_TOPIC_REACTION_TOTALS(TOPIC_ID);
CREATE INDEX IDXq3yulh1p20c1eggq63he9mvoh ON CONV_TOPIC_REACTIONS(TOPIC_ID, USER_ID);
CREATE INDEX IDXqu1kvjnw63lom1ymespiiomqm ON CONV_TOPIC_REACTIONS(TOPIC_ID);
CREATE INDEX IDXtf2j5cl6yv4mrhxb06oc4s4hu ON CONV_COMMENTS(POST_ID);

ALTER TABLE CONV_COMMENTS ADD CONSTRAINT FK5ivsmxyitqpbm7pmdnu3lnmyi FOREIGN KEY (POST_ID) REFERENCES CONV_POSTS (POST_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE CONV_POSTS ADD CONSTRAINT FKc21ukywsqsqilxlsdrg4x6qka FOREIGN KEY (PARENT_POST_ID) REFERENCES CONV_POSTS (POST_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE CONV_USER_STATISTICS ADD CONSTRAINT FKi9pfkqq0396p0kl718e9mrakk FOREIGN KEY (TOPIC_ID) REFERENCES CONV_TOPICS (TOPIC_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE CONV_POST_REACTION_TOTALS ADD CONSTRAINT FKirwlickqy5sf8o9ejk1qkuit6 FOREIGN KEY (POST_ID) REFERENCES CONV_POSTS (POST_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE CONV_TOPIC_GROUPS ADD CONSTRAINT FKj8o3cwa4flprmopiaa1xxi91s FOREIGN KEY (TOPIC_ID) REFERENCES CONV_TOPICS (TOPIC_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE CONV_TOPIC_REACTIONS ADD CONSTRAINT FKpwv7vrkag66g9kq6gghtc4uy1 FOREIGN KEY (TOPIC_ID) REFERENCES CONV_TOPICS (TOPIC_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE CONV_POSTS ADD CONSTRAINT FKqaspmpv6ull7whideia5i2cnb FOREIGN KEY (TOPIC_ID) REFERENCES CONV_TOPICS (TOPIC_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE CONV_TOPIC_REACTION_TOTALS ADD CONSTRAINT FKqu7eyh63vtkowyqoqa9xy7wmq FOREIGN KEY (TOPIC_ID) REFERENCES CONV_TOPICS (TOPIC_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE CONV_POST_REACTIONS ADD CONSTRAINT FKqv38yghf2km7vq1i717xywih6 FOREIGN KEY (POST_ID) REFERENCES CONV_POSTS (POST_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE CONV_TOPIC_TAGS ADD CONSTRAINT FKrmek6b1bqs2jghppp27ph2dn9 FOREIGN KEY (TOPIC_ID) REFERENCES CONV_TOPICS (TOPIC_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
-- END SAK-45092

-- SAK-45616
CREATE TABLE SAM_SECUREDELIVERY_T (
  ID BIGINT AUTO_INCREMENT NOT NULL, 
  PUB_ASSESSMENT_ID BIGINT NOT NULL, 
  AGENTID VARCHAR(99) NOT NULL, 
  ASSESSMENTGRADINGID BIGINT DEFAULT NULL NULL, 
  CREATED_DATE datetime NOT NULL, 
  INSTRUCTOR_URL VARCHAR(1000) NULL, 
  STUDENT_URL VARCHAR(1000) NULL, 
  CONSTRAINT PK_SAM_SECUREDELIVERY_T PRIMARY KEY (ID)
);

CREATE INDEX SAM_SECURE_INDEX ON SAM_SECUREDELIVERY_T(PUB_ASSESSMENT_ID, AGENTID);
-- END SAK-45616

-- SAK-46685
CREATE TABLE TIMESHEET_ENTRY (
  ID BIGINT AUTO_INCREMENT NOT NULL,
  TEXT_COMMENT VARCHAR(4000) NULL,
  DURATION VARCHAR(255) NULL,
  `REFERENCE` VARCHAR(255) NOT NULL,
  START_TIME datetime NOT NULL,
  USER_ID VARCHAR(99) NULL,
  CONSTRAINT PK_TIMESHEET_ENTRY PRIMARY KEY (ID)
);

CREATE INDEX IDX_TIMESHEETENTRY_REF_USER ON TIMESHEET_ENTRY(`REFERENCE`, USER_ID);
-- END SAK-46685

-- SAK-45601
CREATE TABLE TINCANAPI_EVENT (
  EVENT VARCHAR(255) NOT NULL,
  EVENT_SUPPLIER VARCHAR(255) NULL,
  OBJECT VARCHAR(255) NOT NULL,
  ORIGIN VARCHAR(255) NOT NULL,
  VERB VARCHAR(255) NOT NULL,
  CONSTRAINT PK_TINCANAPI_EVENT PRIMARY KEY (EVENT)
);
-- END SAK-45601

-- SAK-45987
CREATE TABLE rbc_returned_criterion_out (
  id BIGINT AUTO_INCREMENT NOT NULL,
  comments LONGTEXT NULL,
  criterion_id BIGINT DEFAULT NULL NULL,
  points DOUBLE DEFAULT NULL NULL,
  pointsAdjusted BIT NOT NULL,
  selected_rating_id BIGINT DEFAULT NULL NULL,
  CONSTRAINT PK_RBC_RETURNED_CRITERION_OUT PRIMARY KEY (id)
);

CREATE TABLE rbc_returned_criterion_outs (
  rbc_returned_evaluation_id BIGINT NOT NULL,
  rbc_returned_criterion_out_id BIGINT NOT NULL,
  UNIQUE (rbc_returned_criterion_out_id)
);

CREATE TABLE rbc_returned_evaluation (
  id BIGINT AUTO_INCREMENT NOT NULL,
  original_evaluation_id BIGINT NOT NULL,
  overallComment VARCHAR(255) NULL,
  CONSTRAINT PK_RBC_RETURNED_EVALUATION PRIMARY KEY (id)
);

CREATE INDEX FK3sroha5yjh3cbvq0on02wf3fk ON rbc_returned_criterion_out(criterion_id);
CREATE INDEX rbc_ret_orig_id ON rbc_returned_evaluation(original_evaluation_id);
CREATE INDEX returned_evaluation_id_key ON rbc_returned_criterion_outs(rbc_returned_evaluation_id);

ALTER TABLE rbc_returned_criterion_out ADD CONSTRAINT FK3sroha5yjh3cbvq0on02wf3fk FOREIGN KEY (criterion_id) REFERENCES rbc_criterion (id) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE rbc_returned_criterion_outs ADD CONSTRAINT returned_criterion_out_id_fk FOREIGN KEY (rbc_returned_criterion_out_id) REFERENCES rbc_returned_criterion_out (id) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE rbc_returned_criterion_outs ADD CONSTRAINT returned_evalution_id_fk FOREIGN KEY (rbc_returned_evaluation_id) REFERENCES rbc_returned_evaluation (id) ON UPDATE RESTRICT ON DELETE RESTRICT;
-- END SAK-45987

-- SAK-41604
ALTER TABLE rbc_evaluation ADD evaluated_item_owner_type INT DEFAULT null NULL;
-- END SAK-41604

-- SAK-43155
ALTER TABLE ASN_SUBMISSION_SUBMITTER ADD TIME_SPENT VARCHAR(255) NULL;
-- END SAK-43155

-- SAK-46686
ALTER TABLE GB_GRADE_RECORD_T ADD ENTERED_POINTS DOUBLE DEFAULT null NULL;
-- END SAK-46686

-- SAK-46137
ALTER TABLE SAKAI_PERSON_T ADD ORCID VARCHAR(255) NULL;
-- END SAK-46137

-- SAK-44784
ALTER TABLE SAKAI_SYLLABUS_ATTACH MODIFY lockId INT NULL;
ALTER TABLE SAKAI_SYLLABUS_ATTACH ALTER lockId SET DEFAULT null;
ALTER TABLE SAKAI_SYLLABUS_DATA MODIFY lockId INT NULL;
ALTER TABLE SAKAI_SYLLABUS_DATA ALTER lockId SET DEFAULT null;
ALTER TABLE SAKAI_SYLLABUS_ITEM MODIFY lockId INT NULL;
ALTER TABLE SAKAI_SYLLABUS_ITEM ALTER lockId SET DEFAULT null;
-- END SAK-44784

-- SAK-45194
ALTER TABLE rbc_evaluation MODIFY status INT NULL;
ALTER TABLE rbc_evaluation ALTER status SET DEFAULT null;
-- END SAK-45194
 
-- SAK-49006
DELETE FROM email_template_item WHERE TEMPLATE_KEY IN ('sitemanage.siteImport.Confirmation', 'sitemange.notifyAddedParticipant', 'sitemanage.notifyNewUserEmail');
-- END SAK-49006
